{% extends "base.html" %}

{% block content %}
<div class="card shadow files-card">
    <div class="card-body p-5">
        <h2 class="text-center mb-4">Управление видеофайлами</h2>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="alert alert-info" role="alert">
                    {% for message in messages %}
                        {{ message }}
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Область загрузки файлов -->
        <div class="upload-area" id="drop-area">
            <form method="post" enctype="multipart/form-data" id="upload-form">
                <p class="mb-3">Перетащите видеофайл сюда или нажмите для выбора</p>
                <input type="file" id="fileInput" name="file" accept="video/*" class="d-none">
                <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    Выбрать файл
                </button>
            </form>
        </div>

        <!-- Список загруженных файлов -->
        <div class="files-container">
            {% if files and files|length > 0 %}
                <h3 class="mb-4">Загруженные видео:</h3>
                {% for file in files %}
                    <div class="video-wrapper">
                        <video 
                            id="video-{{ file.object_name }}" 
                            class="video-js vjs-default-skin" 
                            controls 
                            preload="metadata" 
                            controlsList="nodownload" 
                            oncontextmenu="return false;" 
                            width="640" 
                            height="360"
                            data-setup='{"fluid": true}'>
                            <source src="{{ url_for('download_file', bucket=session.username.split('@')[0].lower(), object_name=file.object_name) }}" type="video/mp4">
                            Ваш браузер не поддерживает HTML5 видео.
                        </video>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-center text-muted">Видео не найдены.</p>
            {% endif %}
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Drag and drop functionality
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('fileInput');
    const uploadForm = document.getElementById('upload-form');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults (e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropArea.classList.add('dragover');
    }

    function unhighlight(e) {
        dropArea.classList.remove('dragover');
    }

    dropArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        uploadForm.submit();
    }

    // Автоматическая отправка формы при выборе файла
    fileInput.addEventListener('change', () => {
        uploadForm.submit();
    });
</script>
{% endblock %}
{% endblock %} 